name: Deploy Spring Boot CRM to AWS EC2

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout source code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Setup Java (Maven Build)
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Build Spring Boot JAR
      - name: Build JAR (skip tests)
        run: mvn -B clean package -DskipTests=true

      # 4. Build Docker Image
      - name: Build Docker Image
        run: docker build -t crm-backend .

      # 5. Save Docker Image to TAR
      - name: Save Docker Image to TAR
        run: docker save crm-backend -o crm-backend.tar

      - name: Fix TAR permissions
        run: chmod 644 crm-backend.tar

      # 6. Debug workspace (optional)
      - name: Debug workspace
        run: ls -R .

      # 7. Upload Docker image + Compose file to EC2
      - name: Upload to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          source: "crm-backend.tar,docker-compose.yml"
          target: "/home/${{ secrets.EC2_USER }}/crm/"

      # 8. Install Docker + Compose on EC2, Deploy app
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v0.1.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          script: |
            echo "=== Updating EC2 Instance ==="
            echo "" | sudo -S apt-get update -y

            # ---------------------------------------
            # Install Docker if missing
            # ---------------------------------------
            if ! command -v docker &> /dev/null
            then
              echo "=== Installing Docker ==="
              echo "" | sudo -S apt-get install -y ca-certificates curl gnupg
              echo "" | sudo -S install -m 0755 -d /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo tee /etc/apt/keyrings/docker.gpg > /dev/null
              echo "" | sudo -S chmod a+r /etc/apt/keyrings/docker.gpg

              echo \
              "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
              $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

              echo "" | sudo -S apt-get update -y
              echo "" | sudo -S apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin
            fi

            # ---------------------------------------
            # Install Docker Compose plugin if needed
            # ---------------------------------------
            if ! docker compose version &> /dev/null
            then
              echo "=== Installing Docker Compose plugin ==="
              echo "" | sudo -S mkdir -p /usr/libexec/docker/cli-plugins/
              echo "" | sudo -S curl -SL https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-linux-x86_64 \
                -o /usr/libexec/docker/cli-plugins/docker-compose
              echo "" | sudo -S chmod +x /usr/libexec/docker/cli-plugins/docker-compose
            fi

            # ---------------------------------------
            # Allow docker without sudo
            # ---------------------------------------
            echo "" | sudo -S usermod -aG docker $USER

            # ---------------------------------------
            # Start Docker Service if not running
            # ---------------------------------------
            echo "=== Starting Docker Service if needed ==="
            sudo systemctl start docker

            echo "=== Deploying Application ==="
            cd ~/crm

            docker load -i crm-backend.tar
            docker compose down || true
            docker compose up -d --force-recreate

            echo "=== Deployment Successful! ==="
