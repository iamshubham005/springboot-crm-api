name: Deploy CRM Backend to AWS EC2 (Amazon Linux)

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------
      # Step 1: Checkout source code
      # ---------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------
      # Step 2: Setup Java 17
      # ---------------------------------------
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      # ---------------------------------------
      # Step 3: Build the JAR (skip tests)
      # ---------------------------------------
      - name: Build Spring Boot JAR
        run: mvn -B clean package -DskipTests=true

      # ---------------------------------------
      # Step 4: Copy source code and docker-compose file to EC2
      # ---------------------------------------
      - name: Copy source code and docker-compose.yml to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          source: "docker-compose.yml,pom.xml,target/*.jar"
          target: "/home/${{ secrets.EC2_USER }}/crm"

      # ---------------------------------------
      # Step 5: SSH into EC2 to build the Docker image and deploy
      # ---------------------------------------
      - name: SSH into EC2 → Build Docker image and Deploy container
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          port: ${{ secrets.EC2_PORT }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail

            DEPLOY_DIR=/home/${USER}/crm
            IMAGE_NAME=crm-backend
            DOCKER_PLUGIN_PATH=/usr/libexec/docker/cli-plugins

            echo "=== Preparing directory $DEPLOY_DIR ==="
            mkdir -p "$DEPLOY_DIR"
            cd "$DEPLOY_DIR"

            # ---------------------------------------
            # Install Docker CE (Amazon Linux 2023)
            # ---------------------------------------
            if ! command -v docker >/dev/null 2>&1 ; then
              echo "Docker not found — installing (Amazon Linux 2023)"

              sudo dnf update -y
              sudo dnf install -y docker

              sudo systemctl start docker
              sudo systemctl enable docker
            else
              echo "Docker present: $(docker --version)"
            fi

            # ---------------------------------------
            # Install Docker Compose v2 plugin
            # ---------------------------------------
            if ! docker compose version >/dev/null 2>&1 ; then
              echo "Installing Docker Compose CLI plugin"

              sudo mkdir -p "$DOCKER_PLUGIN_PATH"
              sudo curl -SL \
                https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-linux-x86_64 \
                -o "$DOCKER_PLUGIN_PATH/docker-compose"

              sudo chmod +x "$DOCKER_PLUGIN_PATH/docker-compose"
            else
              echo "Docker Compose present: $(docker compose version)"
            fi

            # ---------------------------------------
            # Add EC2 user to docker group
            # ---------------------------------------
            if ! groups $USER | grep -q docker ; then
              echo "Adding $USER to docker group"
              sudo usermod -aG docker $USER
            fi

            # ---------------------------------------
            # Build Docker image from the source code
            # ---------------------------------------
            echo "Building Docker image on EC2"
            sudo docker build -t crm-backend .

            # ---------------------------------------
            # Deploy using docker compose
            # ---------------------------------------
            echo "Deploying container using docker compose"
            sudo docker compose down || true
            sudo docker compose up -d --force-recreate

            echo "=== Deployment complete ==="
