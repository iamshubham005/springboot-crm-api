name: Deploy Spring Boot CRM to AWS EC2

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout source code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Setup Java (Maven Build)
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Build Spring Boot JAR
      - name: Build JAR (skip tests)
        run: mvn -B clean package -DskipTests=true

      # 4. Build Docker Image
      - name: Build Docker Image
        run: docker build -t crm-backend .

      # 5. Save Docker Image to TAR
      - name: Save Docker Image to TAR
        run: docker save crm-backend -o crm-backend.tar

      - name: Fix TAR permissions
        run: chmod 644 crm-backend.tar

      # 6. Debug workspace (optional)
      - name: Debug workspace
        run: ls -R .

      # 7. Upload Docker image + Compose file to EC2
      - name: Upload to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          source: "crm-backend.tar,docker-compose.yml"
          target: "/home/${{ secrets.EC2_USER }}/crm/"

      # 8. Add SSH Key to Agent
      - name: Add SSH Key to Agent
        run: |
          eval $(ssh-agent -s)
          echo "${{ secrets.EC2_SSH_KEY }}" | ssh-add -

          # 9. Install Docker + Compose on Amazon Linux EC2 and Deploy the Application
      - name: Install Docker and Deploy on EC2 (Amazon Linux)
        uses: appleboy/ssh-action@v0.1.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          script: |
            echo "=== Fixing SSH Permissions ==="
            chmod 700 ~/.ssh
            chmod 600 ~/.ssh/authorized_keys

            # ---------------------------------------
            # Install Docker on Amazon Linux 2
            # ---------------------------------------
            if ! command -v docker &> /dev/null
            then
              echo "=== Installing Docker (Amazon Linux) ==="
              sudo yum update -y
              sudo amazon-linux-extras install docker -y
              sudo service docker start
              sudo systemctl enable docker
            else
              echo "=== Docker already installed ==="
            fi

            # ---------------------------------------
            # Install Docker Compose (Amazon Linux)
            # ---------------------------------------
            if ! docker compose version &> /dev/null
            then
              echo "=== Installing Docker Compose v2 ==="
              sudo mkdir -p /usr/libexec/docker/cli-plugins/
              sudo curl -SL https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-linux-x86_64 \
                -o /usr/libexec/docker/cli-plugins/docker-compose
              sudo chmod +x /usr/libexec/docker/cli-plugins/docker-compose
            else
              echo "=== Docker Compose already installed ==="
            fi

            # ---------------------------------------
            # Add EC2 user to docker group
            # ---------------------------------------
            sudo usermod -aG docker $USER

            # ---------------------------------------
            # Deploy Application
            # ---------------------------------------
            echo "=== Deploying Application to Amazon Linux EC2 ==="
            cd ~/crm
            docker load -i crm-backend.tar
            docker compose down || true
            docker compose up -d --force-recreate

            echo "=== Deployment Successful on Amazon Linux! ==="

